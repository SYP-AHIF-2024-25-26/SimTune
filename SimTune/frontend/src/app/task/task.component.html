<div
  *ngIf="showStatusText"
  class="fixed inset-0 z-50 backdrop-blur-sm flex items-center justify-center"
  [ngClass]="{
    'bg-red-900/40': !isCorrect,
    'bg-green-900/40': isCorrect
  }"
>
  <div class="relative text-center px-6"
    [ngClass]="{
      'shake': !isCorrect,
      'slide-in': isCorrect
    }">
    <h1
      [ngClass]="{
        'text-green-400': isCorrect,
        'text-red-400': !isCorrect
      }"
      class="text-3xl sm:text-4xl md:text-5xl font-extrabold mb-4"
    >
      {{ isCorrect ? 'Richtig!' : 'Falsch!' }}
    </h1>

    <p class="text-white text-lg sm:text-xl opacity-90">
      {{ isCorrect
        ? 'Auf zur nächsten Aufgabe …'
        : 'Versuche es noch einmal' }}
    </p>

    <canvas
      *ngIf="isCorrect"
      #confettiCanvas
      class="absolute -top-24 left-1/2 -translate-x-1/2
             w-64 h-64 pointer-events-none"
    ></canvas>
  </div>
</div>

@if (showCancelDialog) {
  <div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-lg p-6 w-80">
      <div class="text-lg font-semibold mb-2">Vorgang abbrechen?</div>
      <div class="text-sm text-gray-600 mb-4">
        Nicht gespeicherte Änderungen gehen verloren.
      </div>

      <div class="flex justify-end gap-3">
        <button
          class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700"
          (click)="showCancelDialog = false"
        >
          Weiterarbeiten
        </button>

        <button
          class="px-4 py-2 text-sm text-red-600 hover:text-red-700"
          (click)="goBack()"
        >
          Abbrechen
        </button>
      </div>
    </div>
  </div>
}


<div class="p-2 sm:p-4">
  <div *ngIf="parsed?.length"
      class="text-center text-sm sm:text-base text-gray-500 font-medium mt-10 mb-1">
    {{ isPruefung === 'yes' ? 'Prüfungssimulation' : parsed[0].description }}
  </div>
  <!--  Header  -->
  <div class="flex justify-center items-center mx-2 sm:mx-8 md:mx-16 lg:mx-32 xl:mx-52 mt-1 mb-4">
    <div
      (click)="showCancelDialog = true"
      class="text-sm italic underline cursor-pointer text-gray-500 hover:text-gray-700 ml-2 sm:ml-4 md:ml-8 select-none"
    >
      Abbrechen
    </div>

    <div class="h-5 sm:h-6 w-full sm:w-3/4 bg-costumGray rounded-2xl shadow-lg mx-3 sm:mx-6 md:mx-12 relative">
      <div class="absolute h-full bg-blue-500 rounded-2xl transition-all duration-300" [style.width.%]="(progress / totalSegments) * 100"></div>
    </div>

    <span class="text-xs sm:text-sm text-gray-600 font-medium h-5 sm:h-6 w-auto whitespace-nowrap">
      {{ progress }}/{{ totalSegments }}
    </span>
  </div>

  <div *ngIf="progress < totalSegments" class="justify-center items-center flex font-semibold text-xl sm:text-2xl md:text-3xl lg:text-4xl px-2 sm:px-4 text-center">
    {{ instruction() }}
  </div>

  <div *ngIf="progress < totalSegments" class="flex items-center justify-center mt-6 sm:mt-8 md:mt-12 flex-col px-2 sm:px-4">
    <ng-container *ngIf="this.notationType=='Klavier' || this.exerciseModus=='Schreiben'; else abcNotationTemplate">
      <ng-container *ngIf="exerciseType == 'StammtoeneKlavier' || exerciseType == 'Tonleitern'; else notensystemTemplate">
        <app-piano [action]="this.exerciseModus" [currentQuestion]="this.shuffledContents[this.currentIndex]" [toneType]="this.notationType" (enableButton)="onSelectedKeyChanged($event)"></app-piano>
      </ng-container>
      <ng-template #notensystemTemplate>
        <app-notesystem [action]="this.exerciseModus" [currentQuestion]="this.shuffledContents[this.currentIndex]" [isIntervall]="false" (enableButton)="onSelectedKeyChanged($event)"></app-notesystem>
      </ng-template>
    </ng-container>
    <ng-template #abcNotationTemplate>
      <div class="w-full flex items-center justify-center flex-col mb-12 sm:mb-16 md:mb-20">
        <div #abcContainer id="abc-container" class="transform scale-[0.7] sm:scale-90 md:scale-100 origin-center w-full flex justify-center"></div>
      </div>
    </ng-template>

    <div class="flex flex-wrap justify-center gap-2 sm:gap-3 md:gap-4 mt-4 sm:mt-6">
      <button
        *ngFor="let answers of allAnswers()"
        #button
        [disabled]="!possibleAnswers?.includes(answers)"
        [ngClass]="{
          'bg-green-500 text-white': lastPressedLetter == answers,
          'enabled-button': possibleAnswers?.includes(answers),
          'disabled-button': !possibleAnswers?.includes(answers)
        }"
        class="p-2 sm:p-3 md:p-3 rounded text-lg sm:text-xl md:text-2xl font-semibold min-w-[70px] sm:min-w-[80px] md:min-w-[90px]"
        (click)="checkIfRightButton(answers, button)">
        {{ answers }}
      </button>
    </div>

    <div class="flex justify-center z-1 mt-4 sm:mt-6" *ngIf="exerciseModus == 'Schreiben'">
      <div class="flex-1 flex justify-center z-1"   [ngStyle]="{
        'margin-top': exerciseType === 'StammtoeneKlavier' ? '-10px' : '-45px'
      }">
        <button
          (click)="checkRightWriting()"
          class="text-white bg-costumBlue p-2 sm:p-3 px-4 sm:px-6 py-2 rounded-3xl hover:bg-blue-600 text-sm sm:text-base">
          Antworten
        </button>
      </div>
    </div>

    <div class="relative flex flex-col items-center justify-center mt-6 sm:mt-8 md:mt-12 h-6" *ngIf="exerciseModus === 'Schreiben'">
      <h1
          *ngIf="showStatusText"
          [ngClass]="{
            'text-green-500': isCorrect,
            'text-red-500': !isCorrect
          }"
          class="text-xl sm:text-2xl md:text-3xl font-bold fade-in-up z-20 transition-all duration-700"
        >
          {{ isCorrect ? 'Richtig!' : 'Falsch!' }}
      </h1>

      <canvas #confettiCanvas class="absolute -top-8 sm:-top-12 left-1/2 -translate-x-1/2 w-32 sm:w-40 h-32 sm:h-40 pointer-events-none z-[9999]"></canvas>
    </div>
  </div>
  <!-- Progressbar -->
  <div *ngIf="progress == totalSegments" class="flex flex-col justify-center items-center p-3 sm:p-4 md:p-6 px-2 sm:px-4">
    <p
      class="-mt-2 sm:-mt-4 text-xl sm:text-2xl md:text-3xl lg:text-4xl font-semibold text-center"
    >
      {{ isPruefung === 'yes'
        ? 'Du hast die Prüfungssimulation erfolgreich abgeschlossen!'
        : 'Du hast die Übung erfolgreich abgeschlossen!' }}
    </p>
    <div class="relative my-3 sm:my-4">
      <svg width="150" height="150" viewBox="0 0 100 100" class="mx-auto sm:w-[200px] sm:h-[200px]">
        <circle
            cx="50"
            cy="50"
            r="45"
            stroke="#6496FF"
            stroke-width="10"
            fill="none"
            stroke-linecap="round"
        />
        <circle
            cx="50"
            cy="50"
            r="45"
            stroke="#FFFFFF"
            stroke-width="11"
            fill="none"
            [attr.stroke-dasharray]="dashArray + ', 1000'"
            [attr.stroke-dashoffset]="dashOffset"
            transform="rotate(-90 50 50)"
        />
        <text x="50%" y="50%" text-anchor="middle" dy=".3em" class="text-lg sm:text-xl font-bold">Super!</text>
      </svg>
    </div>
    <p class="text-xl sm:text-2xl font-semibold">Bewertung</p>
    <span class="font-bold text-lg sm:text-xl text-green-600">{{ evaluation }}</span>
    <p class="text-base sm:text-lg text-center">
        <span class="font-bold">{{ firstAttemptCorrectCount }}</span>/{{ totalSegments }} Fragen richtig
    </p>
    <div class="mt-6 sm:mt-8 flex flex-col sm:flex-row gap-4 sm:gap-6 md:gap-10 w-full sm:w-auto px-4 sm:px-0">
      <button (click)="goBack()" class="bg-costumBlue py-2 px-3 text-base sm:text-lg rounded-2xl font-medium w-full sm:w-40 hover:bg-blue-500 hover:shadow-lg transition duration-200">Zurück</button>
      @if(isPruefung === "yes") {
        <button (click)="goToProfilePage()" class="bg-costumBlue py-2 px-3 text-base sm:text-lg rounded-2xl font-medium w-full sm:w-40 hover:bg-blue-500 hover:shadow-lg transition duration-200">Zur Profile-Page</button>
      } @else {
        <button (click)="nextTask()" class="bg-costumBlue py-2 px-3 text-base sm:text-lg rounded-2xl font-medium w-full sm:w-40 hover:bg-blue-500 hover:shadow-lg transition duration-200">Nächste Übung</button>
      }
    </div>
  </div>
</div>
