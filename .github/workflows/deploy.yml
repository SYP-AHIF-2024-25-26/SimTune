name: Build & Deploy to LeoCloud

on:
  push:
    branches:
      - main

env:
  # Diese werden nur noch für den Secret-Creation Step gebraucht, 
  # nicht mehr global für alle Steps (außer du brauchst sie explizit).
  # Wir referenzieren sie unten direkt via secrets.*
  API_URL: ${{ secrets.API_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Frontend Image
        # Frontend braucht die URL beim Build (da statisches HTML/JS)
        run: |
          docker build \
            --no-cache \
            --build-arg API_URL="$API_URL" \
            -t ghcr.io/syp-ahif-2024-25-26/simtune-frontend:latest \
            ./SimTune/frontend
          docker push ghcr.io/syp-ahif-2024-25-26/simtune-frontend:latest
        env:
          API_URL: ${{ secrets.API_URL}}

      - name: Build & Push Backend Image
        # KEINE SECRETS MEHR HIER! Nur noch der Code.
        run: |
          docker buildx build \
            --no-cache \
            -t ghcr.io/syp-ahif-2024-25-26/simtune-backend:latest \
            --push \
            ./SimTune/backend

      - name: Build & Push Adminer Image
        run: |
          docker build --no-cache -t ghcr.io/syp-ahif-2024-25-26/simtune-adminer:latest ./SimTune/adminer
          docker push ghcr.io/syp-ahif-2024-25-26/simtune-adminer:latest

      - name: Setup Kubeconfig for LeoCloud
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

      - name: Create Secrets in LeoCloud
        # HIER werden die Secrets von GitHub in die Cloud übertragen
        run: |
          kubectl delete secret simtune-secrets --ignore-not-found
          kubectl create secret generic simtune-secrets \
            --from-literal=APP_URL='${{ secrets.APP_URL }}' \
            --from-literal=JWT_KEY='${{ secrets.JWT_KEY }}' \
            --from-literal=JWT_ISSUER='${{ secrets.JWT_ISSUER }}' \
            --from-literal=JWT_AUDIENCE='${{ secrets.JWT_AUDIENCE }}' \
            --from-literal=CONNECTION_STRING='${{ secrets.CONNECTION_STRING }}' \
            --from-literal=EXERCISE_CONTENTS='${{ secrets.EXERCISE_CONTENTS }}'

      - name: Delete all old resources (LeoCloud)
        # Vorsicht: Das löscht auch den PVC wenn er im Deployment File definiert ist! 
        # Meistens besser nur deployments/services zu löschen oder einfach apply drüber laufen zu lassen.
        run: |
          kubectl delete deployments,services,ingresses,configmaps --all || true

      - name: Apply new deployment.yaml
        run: |
          kubectl apply -f SimTune/deployment.yaml